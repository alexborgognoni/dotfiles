---
# Apply individual GNOME dconf settings
# These override the base settings loaded from common.conf

- name: Set favorite apps
  dconf:
    key: "/org/gnome/shell/favorite-apps"
    value: "{{ favorite_apps }}"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  when: favorite_apps is defined
  tags: ['gnome-settings']

- name: Configure desktop interface preferences
  dconf:
    key: "/org/gnome/desktop/interface/{{ item.key }}"
    value: "{{ item.value }}"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  loop: "{{ interface_settings }}"
  when: interface_settings is defined
  tags: ['gnome-settings']

- name: Configure desktop background
  dconf:
    key: "/org/gnome/desktop/background/{{ item.key }}"
    value: "{{ item.value }}"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  loop: "{{ background_settings }}"
  when: background_settings is defined
  tags: ['gnome-settings']

- name: Configure mutter settings
  dconf:
    key: "/org/gnome/mutter/{{ item.key }}"
    value: "{{ item.value }}"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  loop: "{{ mutter_settings | default([]) }}"
  when: mutter_settings is defined
  tags: ['gnome-settings']

- name: Configure mouse settings
  dconf:
    key: "/org/gnome/desktop/peripherals/mouse/{{ item.key }}"
    value: "{{ item.value }}"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  loop: "{{ peripherals_mouse | default([]) }}"
  when: peripherals_mouse is defined
  tags: ['gnome-settings']

- name: Configure touchpad settings
  dconf:
    key: "/org/gnome/desktop/peripherals/touchpad/{{ item.key }}"
    value: "{{ item.value }}"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  loop: "{{ peripherals_touchpad | default([]) }}"
  when: peripherals_touchpad is defined
  tags: ['gnome-settings']

- name: Set shell theme
  dconf:
    key: "/org/gnome/shell/extensions/user-theme/name"
    value: "'{{ shell_theme }}'"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  when: shell_theme is defined
  tags: ['gnome-settings']

- name: Check if kitty is installed
  stat:
    path: "{{ ansible_env.HOME }}/.local/kitty.app/bin/kitty"
  register: kitty_check
  tags: ['gnome-settings']

- name: Register kitty as terminal alternative
  command: update-alternatives --install /usr/bin/x-terminal-emulator x-terminal-emulator {{ ansible_env.HOME }}/.local/kitty.app/bin/kitty 50
  become: yes
  when: kitty_check.stat.exists
  register: kitty_register
  changed_when: kitty_register.rc == 0
  failed_when: false
  tags: ['gnome-settings']

- name: Set kitty as default terminal
  alternatives:
    name: x-terminal-emulator
    path: "{{ ansible_env.HOME }}/.local/kitty.app/bin/kitty"
  become: yes
  when: kitty_check.stat.exists
  tags: ['gnome-settings']
