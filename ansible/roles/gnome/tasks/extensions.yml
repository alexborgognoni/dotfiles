---
# Install and configure GNOME extensions

- name: Check if gnome-shell is installed
  command: which gnome-shell
  register: gnome_shell_check
  ignore_errors: yes
  changed_when: false
  tags: ['gnome-extensions']

- name: Install GNOME Extensions dependencies
  apt:
    name:
      - chrome-gnome-shell
      - gnome-shell-extension-manager
      - gnome-shell-extensions
      - pipx
    state: present
  become: yes
  when: gnome_shell_check.rc == 0
  tags: ['gnome-extensions']

- name: Create extensions directory
  file:
    path: "{{ ansible_env.HOME }}/.local/share/gnome-shell/extensions"
    state: directory
    mode: '0755'
  when: gnome_shell_check.rc == 0
  tags: ['gnome-extensions']

- name: Install gnome-extensions-cli via pipx
  community.general.pipx:
    name: gnome-extensions-cli
    state: present
  when: gnome_shell_check.rc == 0
  tags: ['gnome-extensions']

- name: Inject SSL certificates into gnome-extensions-cli (work profile)
  shell: |
    pipx inject gnome-extensions-cli certifi
    pipx inject gnome-extensions-cli pip-system-certs
  when:
    - gnome_shell_check.rc == 0
    - profile == 'work'
  tags: ['gnome-extensions']

- name: Install GNOME extensions from extensions.gnome.org
  shell: |
    {{ ansible_env.HOME }}/.local/bin/gext install {{ item }}
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  loop: "{{ gnome_extensions }}"
  when:
    - gnome_shell_check.rc == 0
    - gnome_extensions is defined
  ignore_errors: yes
  tags: ['gnome-extensions']

- name: Enable GNOME extensions via CLI
  shell: |
    gnome-extensions enable {{ item }}
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  loop: "{{ gnome_extensions }}"
  when:
    - gnome_shell_check.rc == 0
    - gnome_extensions is defined
  ignore_errors: yes
  tags: ['gnome-extensions']

- name: Set enabled extensions via dconf (fallback)
  dconf:
    key: "/org/gnome/shell/enabled-extensions"
    value: "{{ gnome_extensions | string }}"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  when:
    - gnome_shell_check.rc == 0
    - gnome_extensions is defined
  tags: ['gnome-extensions']

- name: Disable GNOME extensions via CLI
  shell: |
    gnome-extensions disable {{ item }}
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  loop: "{{ gnome_extensions_disabled | default([]) }}"
  when:
    - gnome_shell_check.rc == 0
    - gnome_extensions_disabled is defined
  ignore_errors: yes
  tags: ['gnome-extensions']

- name: Set disabled extensions via dconf (fallback)
  dconf:
    key: "/org/gnome/shell/disabled-extensions"
    value: "{{ gnome_extensions_disabled | string }}"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  when:
    - gnome_shell_check.rc == 0
    - gnome_extensions_disabled is defined
  tags: ['gnome-extensions']

- name: Apply extension-specific settings from dconf
  shell: |
    dconf load /org/gnome/shell/extensions/ < "{{ playbook_dir }}/roles/gnome/files/dconf/extensions.conf"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  when:
    - gnome_shell_check.rc == 0
    - gnome_extensions is defined
  ignore_errors: yes
  tags: ['gnome-extensions']

- name: Set space-bar workspace names (personal profile)
  dconf:
    key: "/org/gnome/shell/extensions/space-bar/state/workspace-names"
    value: "{'1': 'Terminal', '2': 'Browser'}"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  when:
    - gnome_shell_check.rc == 0
    - profile == 'personal'
  tags: ['gnome-extensions']

- name: Set space-bar workspace names (work profile)
  dconf:
    key: "/org/gnome/shell/extensions/space-bar/state/workspace-names"
    value: "{'1': 'Terminal', '2': 'Browser', '3': 'Teams', '4': 'Mail'}"
  environment:
    DBUS_SESSION_BUS_ADDRESS: "{{ dbus_session_bus_address }}"
  when:
    - gnome_shell_check.rc == 0
    - profile == 'work'
  tags: ['gnome-extensions']

- name: Display extension installation message
  debug:
    msg: |
      GNOME Extensions have been configured. Some extensions may need to be installed manually via:
      - GNOME Extensions website (extensions.gnome.org)
      - Extension Manager app
      - Or using: `gnome-extensions install <extension-id>`

      After manual installation, run:
      ansible-playbook -i inventory.yml playbook.yml -e "profile={{ profile }}" --tags gnome-extensions
  when: gnome_shell_check.rc == 0
  tags: ['gnome-extensions']
