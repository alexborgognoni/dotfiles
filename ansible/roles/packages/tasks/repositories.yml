---
# Add APT repositories for packages not in standard Ubuntu repos
# Using modern keyring approach (not deprecated apt-key)

###############################################################################
# Get system architecture (dpkg format: amd64, arm64, etc.)
###############################################################################

- name: Get dpkg architecture
  command: dpkg --print-architecture
  register: dpkg_arch
  changed_when: false
  tags: ['repositories']

###############################################################################
# Clean up potentially conflicting old repositories
###############################################################################

- name: Remove old/conflicting repository files
  file:
    path: "/etc/apt/sources.list.d/{{ item }}"
    state: absent
  loop:
    # Repository files we manage (remove to ensure clean recreation with correct arch)
    - github-cli.list
    - docker.list
    - hashicorp.list
    - azure-cli.list
    - cloudfoundry-cli.list
    - vscode.list
    - google-chrome.list
    - gierens.list
    - touchegg.list
    - foliate.list
    - deadsnakes.list
    - microsoft-prod.list
    - microsoft-edge.list
    # Legacy names that might exist
    - microsoft.list
    # Old PPA format files (created by apt-add-repository)
    - ppa_apandada1_foliate_jammy.list
    - ppa_deadsnakes_ppa_jammy.list
    - ppa_touchegg_stable_jammy.list
    # DEB822 .sources format (created by some installers)
    - github-cli.sources
    - docker.sources
    - hashicorp.sources
    - azure-cli.sources
    - cloudfoundry-cli.sources
    - vscode.sources
    - google-chrome.sources
    - gierens.sources
    - touchegg.sources
    - foliate.sources
    - deadsnakes.sources
    - microsoft-prod.sources
    - microsoft-edge.sources
    - microsoft.sources
    - ppa_apandada1_foliate_jammy.sources
    - ppa_deadsnakes_ppa_jammy.sources
    - ppa_touchegg_stable_jammy.sources
  become: yes
  ignore_errors: yes
  tags: ['repositories']

- name: Remove keys from legacy trusted.gpg keyring
  shell: |
    apt-key del {{ item }} 2>/dev/null || true
  loop:
    - A507B2BBA7803E3B  # Foliate
    - F23C5A6CF475977595C89F51BA6932366A755776  # Deadsnakes
    - C0FCE32AF6B96252                            # Touchegg
  become: yes
  ignore_errors: yes
  tags: ['repositories']

- name: Remove old keyring files from deprecated location
  file:
    path: "/usr/share/keyrings/{{ item }}"
    state: absent
  loop:
    - githubcli-archive-keyring.gpg
    - docker-archive-keyring.gpg
    - microsoft.gpg
    - microsoft-prod.gpg
    - microsoft-edge.gpg
    - google-chrome.gpg
  become: yes
  ignore_errors: yes
  tags: ['repositories']

###############################################################################
# Shared: Microsoft GPG key (used by VS Code, Azure CLI, .NET, Edge)
###############################################################################

- name: Ensure keyrings directory exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes
  tags: ['repositories']

- name: Download and install Microsoft GPG key (shared by all Microsoft repos)
  shell: |
    curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /etc/apt/keyrings/microsoft.gpg
    chmod 644 /etc/apt/keyrings/microsoft.gpg
  args:
    creates: /etc/apt/keyrings/microsoft.gpg
  become: yes
  tags: ['repositories']

###############################################################################
# GitHub CLI
###############################################################################

- name: Download GitHub CLI GPG key
  get_url:
    url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
    dest: /etc/apt/keyrings/githubcli-archive-keyring.gpg
    mode: '0644'
  become: yes
  when: "'gh' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Add GitHub CLI repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
    state: present
    filename: github-cli
  become: yes
  when: "'gh' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

###############################################################################
# Docker
###############################################################################

- name: Ensure keyrings directory exists (Docker)
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes
  when: "'docker-ce' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Download Docker GPG key
  get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: '0644'
  become: yes
  when: "'docker-ce' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Add Docker repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
    filename: docker
  become: yes
  when: "'docker-ce' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

###############################################################################
# Azure CLI (work profile only)
###############################################################################

- name: Add Azure CLI repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/azure-cli/ {{ ansible_distribution_release }} main"
    state: present
    filename: azure-cli
  become: yes
  when:
    - profile == 'work'
    - "'azure-cli' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

###############################################################################
# Terraform (HashiCorp)
###############################################################################

- name: Ensure keyrings directory exists (HashiCorp)
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes
  when: "'terraform' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Download HashiCorp GPG key
  shell: |
    wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /etc/apt/keyrings/hashicorp-archive-keyring.gpg
  args:
    creates: /etc/apt/keyrings/hashicorp-archive-keyring.gpg
  become: yes
  when: "'terraform' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Set permissions on HashiCorp GPG key
  file:
    path: /etc/apt/keyrings/hashicorp-archive-keyring.gpg
    mode: '0644'
  become: yes
  when: "'terraform' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Add HashiCorp repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
    state: present
    filename: hashicorp
  become: yes
  when: "'terraform' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

###############################################################################
# Cloud Foundry CLI (work profile only)
###############################################################################

- name: Ensure keyrings directory exists (Cloud Foundry)
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes
  when:
    - profile == 'work'
    - "'cf8-cli' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Download Cloud Foundry GPG key
  get_url:
    url: https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key
    dest: /etc/apt/keyrings/cloudfoundry.asc
    mode: '0644'
  become: yes
  when:
    - profile == 'work'
    - "'cf8-cli' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Add Cloud Foundry repository
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/cloudfoundry.asc] https://packages.cloudfoundry.org/debian stable main"
    state: present
    filename: cloudfoundry-cli
  become: yes
  when:
    - profile == 'work'
    - "'cf8-cli' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

###############################################################################
# VS Code (Microsoft)
###############################################################################

- name: Add VS Code repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main"
    state: present
    filename: vscode
  become: yes
  when: "'code' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

###############################################################################
# Google Chrome
###############################################################################

- name: Ensure keyrings directory exists (Google Chrome)
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes
  when: "'google-chrome-stable' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Download and install Google Chrome GPG key
  shell: |
    curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /etc/apt/keyrings/google-chrome.gpg
    chmod 644 /etc/apt/keyrings/google-chrome.gpg
  args:
    creates: /etc/apt/keyrings/google-chrome.gpg
  become: yes
  when: "'google-chrome-stable' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Add Google Chrome repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/google-chrome.gpg] https://dl.google.com/linux/chrome/deb/ stable main"
    state: present
    filename: google-chrome
  become: yes
  when: "'google-chrome-stable' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

###############################################################################
# Touchegg (work profile only)
###############################################################################

- name: Ensure keyrings directory exists (Touchegg)
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes
  when:
    - profile == 'work'
    - "'touchegg' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Download Touchegg PPA signing key
  shell: |
    curl -fsSL 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xC0FCE32AF6B96252' | gpg --dearmor -o /etc/apt/keyrings/touchegg.gpg
    chmod 644 /etc/apt/keyrings/touchegg.gpg
  args:
    creates: /etc/apt/keyrings/touchegg.gpg
  become: yes
  when:
    - profile == 'work'
    - "'touchegg' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Add Touchegg repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/touchegg.gpg] https://ppa.launchpadcontent.net/touchegg/stable/ubuntu {{ ansible_distribution_release }} main"
    state: present
    filename: touchegg
  become: yes
  when:
    - profile == 'work'
    - "'touchegg' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

###############################################################################
# eza (modern ls replacement, fork of exa)
###############################################################################

- name: Ensure keyrings directory exists (eza)
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes
  when: "'eza' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Download eza GPG key
  shell: |
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
  args:
    creates: /etc/apt/keyrings/gierens.gpg
  become: yes
  when: "'eza' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Set permissions on eza GPG key
  file:
    path: /etc/apt/keyrings/gierens.gpg
    mode: '0644'
  become: yes
  when: "'eza' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Add eza repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main"
    state: present
    filename: gierens
  become: yes
  when: "'eza' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

###############################################################################
# Foliate (e-book reader)
###############################################################################

- name: Ensure keyrings directory exists (Foliate)
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes
  when: "'foliate' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Download Foliate PPA signing key
  shell: |
    curl -fsSL 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xA507B2BBA7803E3B' | gpg --dearmor -o /etc/apt/keyrings/foliate.gpg
    chmod 644 /etc/apt/keyrings/foliate.gpg
  args:
    creates: /etc/apt/keyrings/foliate.gpg
  become: yes
  when: "'foliate' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

- name: Add Foliate repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/foliate.gpg] https://ppa.launchpadcontent.net/apandada1/foliate/ubuntu {{ ansible_distribution_release }} main"
    state: present
    filename: foliate
  become: yes
  when: "'foliate' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

###############################################################################
# Deadsnakes PPA (Python versions)
###############################################################################

- name: Ensure keyrings directory exists (Deadsnakes)
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes
  tags: ['repositories']

- name: Download Deadsnakes PPA signing key
  shell: |
    curl -fsSL 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xF23C5A6CF475977595C89F51BA6932366A755776' | gpg --dearmor -o /etc/apt/keyrings/deadsnakes.gpg
    chmod 644 /etc/apt/keyrings/deadsnakes.gpg
  args:
    creates: /etc/apt/keyrings/deadsnakes.gpg
  become: yes
  tags: ['repositories']

- name: Add Deadsnakes repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/deadsnakes.gpg] https://ppa.launchpadcontent.net/deadsnakes/ppa/ubuntu {{ ansible_distribution_release }} main"
    state: present
    filename: deadsnakes
  become: yes
  tags: ['repositories']

###############################################################################
# Microsoft .NET
###############################################################################

- name: Add Microsoft .NET repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/ubuntu/{{ ansible_distribution_version }}/prod {{ ansible_distribution_release }} main"
    state: present
    filename: microsoft-prod
  become: yes
  tags: ['repositories']

###############################################################################
# Microsoft Edge (work profile only)
###############################################################################

- name: Add Microsoft Edge repository
  apt_repository:
    repo: "deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/edge stable main"
    state: present
    filename: microsoft-edge
  become: yes
  when:
    - profile == 'work'
    - "'microsoft-edge-stable' in all_apt_packages | map(attribute='name') | list"
  tags: ['repositories']

###############################################################################
# Refresh apt cache after adding repositories
###############################################################################

- name: Update apt cache after adding repositories
  apt:
    update_cache: yes
  become: yes
  tags: ['repositories']
