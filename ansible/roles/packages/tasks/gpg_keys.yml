---
# Download GPG keys for APT repositories
# Handles different key types: binary, asc, armored, keyserver

###############################################################################
# Build list of needed repositories (filtering by packages and profile)
###############################################################################

- name: Initialize repos_needed list
  set_fact:
    repos_needed: []
  tags: ['gpg-keys']

- name: Filter repositories by required packages and profile
  set_fact:
    repos_needed: "{{ repos_needed + [item] }}"
  loop: "{{ apt_repositories }}"
  when:
    - item.required_packages | intersect(all_apt_packages | map(attribute='name') | list) | length > 0
    - (item.profiles is not defined) or (profile in item.profiles)
  loop_control:
    label: "{{ item.name }}"
  tags: ['gpg-keys']

###############################################################################
# Download shared GPG keys (Microsoft, etc.)
###############################################################################

- name: Get list of shared keys needed
  set_fact:
    shared_keys_needed: "{{ repos_needed | selectattr('shared_key', 'defined') | map(attribute='shared_key') | unique | list }}"
  tags: ['gpg-keys']

- name: Download shared GPG keys (armored, needs dearmor)
  shell: |
    curl -fsSL '{{ shared_gpg_keys[item].url }}' | gpg --dearmor -o /etc/apt/keyrings/{{ shared_gpg_keys[item].file }}
    chmod 644 /etc/apt/keyrings/{{ shared_gpg_keys[item].file }}
  args:
    creates: "/etc/apt/keyrings/{{ shared_gpg_keys[item].file }}"
  loop: "{{ shared_keys_needed }}"
  become: yes
  tags: ['gpg-keys']

###############################################################################
# Download binary GPG keys (direct .gpg files)
###############################################################################

- name: Download binary GPG keys
  get_url:
    url: "{{ item.key_url }}"
    dest: "/etc/apt/keyrings/{{ item.key_file }}"
    mode: '0644'
  loop: "{{ repos_needed | selectattr('key_type', 'defined') | selectattr('key_type', 'eq', 'binary') | list }}"
  loop_control:
    label: "{{ item.name }}"
  become: yes
  tags: ['gpg-keys']

###############################################################################
# Download ASC GPG keys (ASCII armored, no dearmor needed)
###############################################################################

- name: Download ASC GPG keys
  get_url:
    url: "{{ item.key_url }}"
    dest: "/etc/apt/keyrings/{{ item.key_file }}"
    mode: '0644'
  loop: "{{ repos_needed | selectattr('key_type', 'defined') | selectattr('key_type', 'eq', 'asc') | list }}"
  loop_control:
    label: "{{ item.name }}"
  become: yes
  tags: ['gpg-keys']

###############################################################################
# Download armored GPG keys (need gpg --dearmor)
###############################################################################

- name: Download and dearmor GPG keys
  shell: |
    curl -fsSL '{{ item.key_url }}' | gpg --dearmor -o /etc/apt/keyrings/{{ item.key_file }}
    chmod 644 /etc/apt/keyrings/{{ item.key_file }}
  args:
    creates: "/etc/apt/keyrings/{{ item.key_file }}"
  loop: "{{ repos_needed | selectattr('key_type', 'defined') | selectattr('key_type', 'eq', 'armored') | list }}"
  loop_control:
    label: "{{ item.name }}"
  become: yes
  tags: ['gpg-keys']

###############################################################################
# Download keyserver GPG keys (Ubuntu keyserver by key_id)
###############################################################################

- name: Download keyserver GPG keys
  shell: |
    curl -fsSL 'https://keyserver.ubuntu.com/pks/lookup?op=get&search={{ item.key_id }}' | gpg --dearmor -o /etc/apt/keyrings/{{ item.key_file }}
    chmod 644 /etc/apt/keyrings/{{ item.key_file }}
  args:
    creates: "/etc/apt/keyrings/{{ item.key_file }}"
  loop: "{{ repos_needed | selectattr('key_type', 'defined') | selectattr('key_type', 'eq', 'keyserver') | list }}"
  loop_control:
    label: "{{ item.name }}"
  become: yes
  tags: ['gpg-keys']
