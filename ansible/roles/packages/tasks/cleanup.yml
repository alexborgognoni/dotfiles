---
# Cleanup old repository files, legacy keys, and conflicting packages
# This runs before GPG key downloads and repository additions

###############################################################################
# System setup
###############################################################################

- name: Get dpkg architecture
  command: dpkg --print-architecture
  register: dpkg_arch
  changed_when: false
  tags: ['cleanup']

- name: Ensure keyrings directory exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes
  tags: ['cleanup']

###############################################################################
# Remove old repository files
###############################################################################

# Static list of managed repository filenames (must match apt_repositories.yml)
- name: Remove old/conflicting repository files
  file:
    path: "/etc/apt/sources.list.d/{{ item }}"
    state: absent
  loop:
    # Managed repos (.list and .sources variants)
    - github-cli.list
    - github-cli.sources
    - docker.list
    - docker.sources
    - hashicorp.list
    - hashicorp.sources
    - vscode.list
    - vscode.sources
    - microsoft-dotnet.list
    - microsoft-dotnet.sources
    - azure-cli.list
    - azure-cli.sources
    - azure-functions.list
    - azure-functions.sources
    - microsoft-edge.list
    - microsoft-edge.sources
    - google-chrome.list
    - google-chrome.sources
    - cloudfoundry-cli.list
    - cloudfoundry-cli.sources
    - gierens.list
    - gierens.sources
    - touchegg.list
    - touchegg.sources
    - foliate.list
    - foliate.sources
    - deadsnakes.list
    - deadsnakes.sources
    # Legacy names
    - microsoft.list
    - microsoft.sources
    - dotnetdev.list
    - dotnetdev.sources
    - microsoft-prod.list
    - microsoft-prod.sources
    # Old PPA format (apt-add-repository)
    - "ppa_apandada1_foliate_{{ ansible_distribution_release }}.list"
    - "ppa_deadsnakes_ppa_{{ ansible_distribution_release }}.list"
    - "ppa_touchegg_stable_{{ ansible_distribution_release }}.list"
  become: yes
  ignore_errors: yes
  tags: ['cleanup']

###############################################################################
# Remove legacy apt-key entries
###############################################################################

- name: Remove keys from legacy trusted.gpg keyring
  shell: |
    apt-key del {{ item }} 2>/dev/null || true
  loop: "{{ legacy_apt_keys }}"
  become: yes
  ignore_errors: yes
  changed_when: false
  tags: ['cleanup']

- name: Remove old keyring files from deprecated location
  file:
    path: "/usr/share/keyrings/{{ item }}"
    state: absent
  loop:
    - githubcli-archive-keyring.gpg
    - docker-archive-keyring.gpg
    - microsoft.gpg
    - microsoft-prod.gpg
    - microsoft-edge.gpg
    - google-chrome.gpg
  become: yes
  ignore_errors: yes
  tags: ['cleanup']

###############################################################################
# Remove conflicting Docker packages
###############################################################################

- name: Check if Docker CE is in package list
  set_fact:
    docker_requested: "{{ 'docker-ce' in (all_apt_packages | map(attribute='name') | list) }}"
  tags: ['cleanup']

- name: Remove conflicting Docker packages
  apt:
    name: "{{ docker_conflicting_packages }}"
    state: absent
    purge: yes
  become: yes
  ignore_errors: yes
  when: docker_requested
  tags: ['cleanup']
