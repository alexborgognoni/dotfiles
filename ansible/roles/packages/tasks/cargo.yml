---
# Cargo (Rust) package installation

- name: Check if cargo is installed
  command: which cargo
  register: cargo_check
  ignore_errors: yes
  changed_when: false
  tags: ['cargo']

- name: Install Rust and Cargo if not present
  shell: |
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    creates: "{{ ansible_env.HOME }}/.cargo/bin/cargo"
  when: cargo_check.rc != 0
  tags: ['cargo']

- name: Add cargo to PATH for current session
  set_fact:
    ansible_env: "{{ ansible_env | combine({'PATH': ansible_env.HOME + '/.cargo/bin:' + ansible_env.PATH}) }}"
  when: cargo_check.rc != 0
  tags: ['cargo']

- name: Check installed cargo packages
  shell: cargo install --list | grep "^{{ item.name }} v" | head -1 || echo "not_installed"
  register: cargo_installed
  loop: "{{ all_cargo_packages }}"
  changed_when: false
  when: all_cargo_packages is defined and all_cargo_packages | length > 0
  tags: ['cargo']

- name: Install Cargo packages
  command: "cargo install {{ item.item.name }}{{ ' --version ' + item.item.version if item.item.version is defined else '' }}"
  loop: "{{ cargo_installed.results }}"
  when:
    - all_cargo_packages is defined
    - all_cargo_packages | length > 0
    - "'not_installed' in item.stdout"
  tags: ['cargo']
