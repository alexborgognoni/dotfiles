---
# Bitwarden session management
# Handles login, unlock, and folder creation

###############################################################################
# Check Bitwarden CLI is installed
###############################################################################

- name: Check Bitwarden CLI is installed
  command: which bw
  register: bw_installed
  changed_when: false
  failed_when: bw_installed.rc != 0

###############################################################################
# Get Bitwarden status
###############################################################################

- name: Get Bitwarden status
  command: bw status
  register: bw_status_result
  changed_when: false

- name: Parse Bitwarden status
  set_fact:
    bw_status: "{{ bw_status_result.stdout | from_json }}"

- name: Display Bitwarden status
  debug:
    msg: "Bitwarden status: {{ bw_status.status }}"

###############################################################################
# Login to Bitwarden (if unauthenticated)
###############################################################################

- name: Login to Bitwarden
  command: bw login
  when: bw_status.status == 'unauthenticated'
  register: bw_login_result

- name: Get updated status after login
  command: bw status
  register: bw_status_after_login
  changed_when: false
  when: bw_login_result is changed

- name: Update Bitwarden status after login
  set_fact:
    bw_status: "{{ bw_status_after_login.stdout | from_json }}"
  when: bw_login_result is changed

###############################################################################
# Unlock Bitwarden vault
###############################################################################

- name: Unlock Bitwarden vault
  command: bw unlock --raw
  register: bw_unlock_result
  when: bw_status.status == 'locked'

- name: Get session from already unlocked vault
  command: bw unlock --raw
  register: bw_session_unlocked
  when: bw_status.status == 'unlocked'
  changed_when: false

- name: Set Bitwarden session fact
  set_fact:
    bw_session: "{{ bw_unlock_result.stdout | default(bw_session_unlocked.stdout) }}"

###############################################################################
# Ensure dotfiles-keys folder exists
###############################################################################

- name: Check if dotfiles-keys folder exists
  command: bw get folder "dotfiles-keys"
  environment:
    BW_SESSION: "{{ bw_session }}"
  register: folder_check
  ignore_errors: yes
  changed_when: false

- name: Create dotfiles-keys folder if not exists
  shell: |
    echo '{"name": "dotfiles-keys"}' | bw encode | bw create folder
  environment:
    BW_SESSION: "{{ bw_session }}"
  when: folder_check.rc != 0

- name: Sync Bitwarden vault
  command: bw sync
  environment:
    BW_SESSION: "{{ bw_session }}"
  changed_when: false
