---
# SSH & GPG Key Setup
# Orchestrates SSH and GPG key generation/retrieval from Bitwarden

###############################################################################
# Setup Bitwarden session
###############################################################################

- name: Set up Bitwarden session
  include_tasks: bitwarden.yml
  tags: ['secrets']

###############################################################################
# SSH Key Passphrase
###############################################################################

- name: Prompt for SSH key passphrase
  pause:
    prompt: "Enter passphrase for SSH keys (leave empty for no passphrase)"
    echo: no
  register: ssh_passphrase_prompt
  tags: ['secrets']

- name: Set SSH passphrase fact
  set_fact:
    ssh_passphrase: "{{ ssh_passphrase_prompt.user_input | default('') }}"
  tags: ['secrets']

###############################################################################
# Ensure .ssh directory exists
###############################################################################

- name: Ensure .ssh directory exists
  file:
    path: "{{ ansible_env.HOME }}/.ssh"
    state: directory
    mode: '0700'
  tags: ['secrets']

###############################################################################
# Set up SSH keys
###############################################################################

- name: Set up SSH keys
  include_tasks: ssh.yml
  loop: "{{ ssh_keys }}"
  loop_control:
    loop_var: ssh_key
    label: "{{ ssh_key.name }}"
  tags: ['secrets']

###############################################################################
# Set up GPG keys (collects key IDs for git signing config)
###############################################################################

- name: Initialize GPG key IDs dict
  set_fact:
    gpg_key_ids: {}
  tags: ['secrets']

- name: Set up GPG keys
  include_tasks: gpg.yml
  loop: "{{ gpg_keys }}"
  loop_control:
    loop_var: gpg_key
    label: "{{ gpg_key.name }}"
  tags: ['secrets']

###############################################################################
# Configure Git signing with GPG keys
###############################################################################

- name: Configure git commit signing
  git_config:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    scope: global
  loop:
    - { name: "user.signingkey", value: "{{ gpg_key_ids['default'] }}" }
    - { name: "commit.gpgsign", value: "true" }
  when: gpg_key_ids['default'] is defined and gpg_key_ids['default'] | length > 0
  tags: ['secrets']

- name: Configure git signing for personal repos (work profile)
  lineinfile:
    path: "{{ ansible_env.HOME }}/.gitconfig-personal"
    regexp: '^\s*signingkey\s*='
    line: "	signingkey = {{ gpg_key_ids['personal'] }}"
    insertafter: '^\[user\]'
  when:
    - profile == 'work'
    - gpg_key_ids['personal'] is defined
    - gpg_key_ids['personal'] | length > 0
  tags: ['secrets']

###############################################################################
# Lock Bitwarden vault
###############################################################################

- name: Lock Bitwarden vault
  command: bw lock
  changed_when: false
  tags: ['secrets']

###############################################################################
# Display setup summary
###############################################################################

- name: Display SSH public keys
  debug:
    msg: |

      ============================================
      SSH Key: {{ item.name }} ({{ item.email }})
      ============================================
      {{ lookup('file', item.path + '.pub') }}
  loop: "{{ ssh_keys }}"
  loop_control:
    label: "{{ item.name }}"
  tags: ['secrets']

- name: Display GPG key instructions
  debug:
    msg: |

      ============================================
      GPG Key: {{ item.name }} ({{ item.email }})
      ============================================
      To export public key for GitHub:
        gpg --armor --export {{ item.email }}
  loop: "{{ gpg_keys }}"
  loop_control:
    label: "{{ item.name }}"
  tags: ['secrets']

- name: Display final instructions
  debug:
    msg: |

      ============================================
      SSH/GPG Keys Setup Complete!
      ============================================

      Add your public keys to GitHub:
        - Personal: https://github.com/settings/keys
      {% if profile == 'work' %}
        - Work: https://github.deutsche-boerse.de/settings/keys
      {% endif %}

      GPG public keys for signing:
        - Personal: https://github.com/settings/gpg
      {% if profile == 'work' %}
        - Work: https://github.deutsche-boerse.de/settings/gpg
      {% endif %}
  tags: ['secrets']
