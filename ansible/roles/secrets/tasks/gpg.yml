---
# GPG key setup for a single key
# Either retrieves from Bitwarden or generates new key and uploads

###############################################################################
# Check if key exists in Bitwarden
###############################################################################

- name: "GPG {{ gpg_key.name }}: Check if key exists in Bitwarden"
  command: bw get item "{{ gpg_key.bw_name }}"
  environment:
    BW_SESSION: "{{ bw_session }}"
  register: bw_gpg_result
  ignore_errors: yes
  changed_when: false

###############################################################################
# Key exists in Bitwarden - import into keyring
###############################################################################

- name: "GPG {{ gpg_key.name }}: Import from Bitwarden"
  block:
    - name: "GPG {{ gpg_key.name }}: Extract private key"
      set_fact:
        gpg_private_key: "{{ (bw_gpg_result.stdout | from_json).fields | selectattr('name', 'eq', 'private_key') | map(attribute='value') | first }}"
        gpg_key_id: "{{ (bw_gpg_result.stdout | from_json).fields | selectattr('name', 'eq', 'key_id') | map(attribute='value') | first }}"

    - name: "GPG {{ gpg_key.name }}: Import private key"
      shell: |
        echo "{{ gpg_private_key }}" | gpg --import --batch 2>&1
      register: gpg_import
      changed_when: "'imported' in gpg_import.stderr or 'imported' in gpg_import.stdout"
      failed_when: false

    - name: "GPG {{ gpg_key.name }}: Trust the key"
      shell: |
        echo -e "5\ny\n" | gpg --command-fd 0 --expert --edit-key "{{ gpg_key_id }}" trust quit 2>/dev/null || true
      changed_when: false

    - name: "GPG {{ gpg_key.name }}: Retrieved from Bitwarden"
      debug:
        msg: "GPG key '{{ gpg_key.name }}' ({{ gpg_key_id }}) imported from Bitwarden"
  when: bw_gpg_result.rc == 0

###############################################################################
# Key not found in Bitwarden - generate new key and upload
###############################################################################

- name: "GPG {{ gpg_key.name }}: Generate new key"
  block:
    - name: "GPG {{ gpg_key.name }}: Create key parameters file"
      copy:
        content: |
          %no-protection
          Key-Type: eddsa
          Key-Curve: ed25519
          Subkey-Type: ecdh
          Subkey-Curve: cv25519
          Name-Real: {{ gpg_key.name_real }}
          Name-Email: {{ gpg_key.email }}
          Expire-Date: 0
          %commit
        dest: "/tmp/gpg-key-params-{{ gpg_key.name }}"
        mode: '0600'

    - name: "GPG {{ gpg_key.name }}: Generate GPG key"
      command: gpg --batch --generate-key "/tmp/gpg-key-params-{{ gpg_key.name }}"

    - name: "GPG {{ gpg_key.name }}: Get new key ID"
      shell: |
        gpg --list-secret-keys --keyid-format=long "{{ gpg_key.email }}" 2>/dev/null | \
          grep -E '^\s*sec' | head -1 | awk '{print $2}' | cut -d'/' -f2
      register: new_gpg_key_id
      changed_when: false

    - name: "GPG {{ gpg_key.name }}: Export private key"
      command: gpg --export-secret-keys --armor "{{ gpg_key.email }}"
      register: gpg_private_export

    - name: "GPG {{ gpg_key.name }}: Export public key"
      command: gpg --export --armor "{{ gpg_key.email }}"
      register: gpg_public_export

    - name: "GPG {{ gpg_key.name }}: Get folder ID"
      shell: bw get folder "dotfiles-keys" | jq -r '.id'
      environment:
        BW_SESSION: "{{ bw_session }}"
      register: folder_id_result
      changed_when: false

    - name: "GPG {{ gpg_key.name }}: Upload to Bitwarden"
      shell: |
        cat << 'BWJSON' | bw encode | bw create item
        {
          "type": 2,
          "name": "{{ gpg_key.bw_name }}",
          "folderId": "{{ folder_id_result.stdout }}",
          "notes": "GPG key for {{ gpg_key.email }}",
          "secureNote": {"type": 0},
          "fields": [
            {"name": "private_key", "value": {{ gpg_private_export.stdout | to_json }}, "type": 1},
            {"name": "public_key", "value": {{ gpg_public_export.stdout | to_json }}, "type": 0},
            {"name": "key_id", "value": "{{ new_gpg_key_id.stdout }}", "type": 0},
            {"name": "email", "value": "{{ gpg_key.email }}", "type": 0}
          ]
        }
        BWJSON
      environment:
        BW_SESSION: "{{ bw_session }}"

    - name: "GPG {{ gpg_key.name }}: Clean up params file"
      file:
        path: "/tmp/gpg-key-params-{{ gpg_key.name }}"
        state: absent

    - name: "GPG {{ gpg_key.name }}: Store key ID (new key)"
      set_fact:
        gpg_key_ids: "{{ gpg_key_ids | combine({gpg_key.name: new_gpg_key_id.stdout}) }}"

    - name: "GPG {{ gpg_key.name }}: Display new public key"
      debug:
        msg: |

          ============================================
          NEW GPG KEY GENERATED: {{ gpg_key.bw_name }}
          ============================================
          Key ID: {{ new_gpg_key_id.stdout }}

          Add this public key to GitHub:

          {{ gpg_public_export.stdout }}
  when: bw_gpg_result.rc != 0

###############################################################################
# Store key ID for git signing configuration
###############################################################################

- name: "GPG {{ gpg_key.name }}: Store key ID (from Bitwarden)"
  set_fact:
    gpg_key_ids: "{{ gpg_key_ids | combine({gpg_key.name: gpg_key_id}) }}"
  when: bw_gpg_result.rc == 0
