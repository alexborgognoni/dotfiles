---
# SSH key setup for a single key
# Either retrieves from Bitwarden or generates new key and uploads

###############################################################################
# Check if key exists in Bitwarden
###############################################################################

- name: "SSH {{ ssh_key.name }}: Check if key exists in Bitwarden"
  command: bw get item "{{ ssh_key.bw_name }}"
  environment:
    BW_SESSION: "{{ bw_session }}"
  register: bw_ssh_result
  ignore_errors: yes
  changed_when: false

###############################################################################
# Key exists in Bitwarden - retrieve and write to disk
###############################################################################

- name: "SSH {{ ssh_key.name }}: Retrieve from Bitwarden"
  block:
    - name: "SSH {{ ssh_key.name }}: Extract private key"
      set_fact:
        ssh_private_key: "{{ (bw_ssh_result.stdout | from_json).fields | selectattr('name', 'eq', 'private_key') | map(attribute='value') | first }}"
        ssh_public_key: "{{ (bw_ssh_result.stdout | from_json).fields | selectattr('name', 'eq', 'public_key') | map(attribute='value') | first }}"

    - name: "SSH {{ ssh_key.name }}: Write private key"
      copy:
        content: "{{ ssh_private_key }}"
        dest: "{{ ssh_key.path }}"
        mode: '0600'

    - name: "SSH {{ ssh_key.name }}: Write public key"
      copy:
        content: "{{ ssh_public_key }}"
        dest: "{{ ssh_key.path }}.pub"
        mode: '0644'

    - name: "SSH {{ ssh_key.name }}: Retrieved from Bitwarden"
      debug:
        msg: "SSH key '{{ ssh_key.name }}' retrieved from Bitwarden and written to {{ ssh_key.path }}"
  when: bw_ssh_result.rc == 0

###############################################################################
# Key not found in Bitwarden - generate new key and upload
###############################################################################

- name: "SSH {{ ssh_key.name }}: Generate new key"
  block:
    - name: "SSH {{ ssh_key.name }}: Generate SSH key"
      command: ssh-keygen -t ed25519 -C "{{ ssh_key.email }}" -f "{{ ssh_key.path }}" -N "{{ ssh_passphrase }}"
      args:
        creates: "{{ ssh_key.path }}"

    - name: "SSH {{ ssh_key.name }}: Read generated private key"
      slurp:
        src: "{{ ssh_key.path }}"
      register: generated_private_key

    - name: "SSH {{ ssh_key.name }}: Read generated public key"
      slurp:
        src: "{{ ssh_key.path }}.pub"
      register: generated_public_key

    - name: "SSH {{ ssh_key.name }}: Get folder ID"
      shell: bw get folder "dotfiles-keys" | jq -r '.id'
      environment:
        BW_SESSION: "{{ bw_session }}"
      register: folder_id_result
      changed_when: false

    - name: "SSH {{ ssh_key.name }}: Upload to Bitwarden"
      shell: |
        cat << 'BWJSON' | bw encode | bw create item
        {
          "type": 2,
          "name": "{{ ssh_key.bw_name }}",
          "folderId": "{{ folder_id_result.stdout }}",
          "notes": "SSH key for {{ ssh_key.email }}",
          "secureNote": {"type": 0},
          "fields": [
            {"name": "private_key", "value": {{ generated_private_key.content | b64decode | to_json }}, "type": 1},
            {"name": "public_key", "value": {{ generated_public_key.content | b64decode | to_json }}, "type": 0},
            {"name": "email", "value": "{{ ssh_key.email }}", "type": 0}
          ]
        }
        BWJSON
      environment:
        BW_SESSION: "{{ bw_session }}"

    - name: "SSH {{ ssh_key.name }}: Display new public key"
      debug:
        msg: |

          ============================================
          NEW SSH KEY GENERATED: {{ ssh_key.bw_name }}
          ============================================
          Add this public key to GitHub:

          {{ generated_public_key.content | b64decode }}
  when: bw_ssh_result.rc != 0
